<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlRoot">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>استخراج النص وتحويله إلى JSON</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root {
      /* Primitive Color Tokens */
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-teal-800: rgba(41, 150, 161, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);

      /* RGB versions for opacity control */
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-red-500-rgb: 192, 21, 47;
      --color-red-400-rgb: 255, 84, 89;
      --color-orange-500-rgb: 168, 75, 47;
      --color-orange-400-rgb: 230, 129, 97;

      /* Background color tokens (Light Mode) */
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-bg-5: rgba(147, 51, 234, 0.08);
      --color-bg-6: rgba(249, 115, 22, 0.08);
      --color-bg-7: rgba(236, 72, 153, 0.08);
      --color-bg-8: rgba(6, 182, 212, 0.08);

      /* Semantic Color Tokens (Light Mode) */
      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --color-info: var(--color-slate-500);
      --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
      --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

      /* Common style patterns */
      --focus-ring: 0 0 0 3px var(--color-focus-ring);
      --focus-outline: 2px solid var(--color-primary);
      --status-bg-opacity: 0.15;
      --status-border-opacity: 0.25;
      --select-caret-light: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      --select-caret-dark: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23f5f5f5' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");

      /* RGB versions for opacity control */
      --color-success-rgb: 33, 128, 141;
      --color-error-rgb: 192, 21, 47;
      --color-warning-rgb: 168, 75, 47;
      --color-info-rgb: 98, 108, 113;

      /* Typography */
      --font-family-base: 'Tajawal', 'FKGroteskNeue', 'Geist', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-family-mono: 'Berkeley Mono', ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --font-size-xs: 11px;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-md: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-size-4xl: 30px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --line-height-tight: 1.2;
      --line-height-normal: 1.5;
      --letter-spacing-tight: -0.01em;

      /* Spacing */
      --space-0: 0;
      --space-1: 1px;
      --space-2: 2px;
      --space-4: 4px;
      --space-6: 6px;
      --space-8: 8px;
      --space-10: 10px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
      --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

      /* Animation */
      --duration-fast: 150ms;
      --duration-normal: 250ms;
      --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

      /* Layout */
      --container-sm: 640px;
      --container-md: 768px;
      --container-lg: 1024px;
      --container-xl: 1280px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-gray-400-rgb: 119, 124, 124;
        --color-teal-300-rgb: 50, 184, 198;
        --color-gray-300-rgb: 167, 169, 169;
        --color-gray-200-rgb: 245, 245, 245;
        --color-bg-1: rgba(29, 78, 216, 0.15);
        --color-bg-2: rgba(180, 83, 9, 0.15);
        --color-bg-3: rgba(21, 128, 61, 0.15);
        --color-bg-4: rgba(185, 28, 28, 0.15);
        --color-bg-5: rgba(107, 33, 168, 0.15);
        --color-bg-6: rgba(194, 65, 12, 0.15);
        --color-bg-7: rgba(190, 24, 93, 0.15);
        --color-bg-8: rgba(8, 145, 178, 0.15);
        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-primary-active: var(--color-teal-800);
        --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
        --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
        --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
        --color-border: rgba(var(--color-gray-400-rgb), 0.3);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
        --color-warning: var(--color-orange-400);
        --color-info: var(--color-gray-300);
        --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
        --color-btn-primary-text: var(--color-slate-900);
        --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
        --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
        --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1), inset 0 -1px 0 rgba(0, 0, 0, 0.15);
        --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);
        --color-success-rgb: var(--color-teal-300-rgb);
        --color-error-rgb: var(--color-red-400-rgb);
        --color-warning-rgb: var(--color-orange-400-rgb);
        --color-info-rgb: var(--color-gray-300-rgb);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      background-color: var(--color-background);
      color: var(--color-text);
      line-height: var(--line-height-normal);
      min-height: 100vh;
      padding: var(--space-20);
    }

    .app-container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .app-header {
      text-align: center;
      margin-bottom: var(--space-32);
      padding: var(--space-24);
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      box-shadow: var(--shadow-md);
    }

    .app-header h1 {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--space-8);
    }

    .app-header p {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
    }

    .main-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-card-border);
      box-shadow: var(--shadow-lg);
      padding: var(--space-32);
      margin-bottom: var(--space-24);
    }

    .form-section {
      margin-bottom: var(--space-24);
    }

    .form-section:last-child {
      margin-bottom: 0;
    }

    .form-label {
      display: block;
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--space-8);
    }

    .file-upload-wrapper {
      position: relative;
      border: 2px dashed var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-32);
      text-align: center;
      background: var(--color-bg-1);
      transition: all var(--duration-normal) var(--ease-standard);
      cursor: pointer;
    }

    .file-upload-wrapper:hover {
      border-color: var(--color-primary);
      background: var(--color-bg-3);
    }

    .file-upload-wrapper input[type="file"] {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-upload-content {
      pointer-events: none;
    }

    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto var(--space-12);
      color: var(--color-primary);
    }

    .upload-text {
      font-size: var(--font-size-base);
      color: var(--color-text);
      margin-bottom: var(--space-4);
    }

    .upload-hint {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .form-input,
    .form-select {
      width: 100%;
      padding: var(--space-12);
      font-size: var(--font-size-base);
      font-family: var(--font-family-base);
      color: var(--color-text);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      transition: all var(--duration-fast) var(--ease-standard);
    }

    .form-input:focus,
    .form-select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--focus-ring);
    }

    .form-select {
      appearance: none;
      background-image: var(--select-caret-light);
      background-repeat: no-repeat;
      background-position: left var(--space-12) center;
      background-size: 16px;
      padding-left: var(--space-32);
    }

    @media (prefers-color-scheme: dark) {
      .form-select {
        background-image: var(--select-caret-dark);
      }
    }

    .divider {
      display: flex;
      align-items: center;
      text-align: center;
      margin: var(--space-20) 0;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      border-bottom: 1px solid var(--color-border);
    }

    .divider::before {
      margin-left: var(--space-12);
    }

    .divider::after {
      margin-right: var(--space-12);
    }

    .button-group {
      display: flex;
      gap: var(--space-12);
      flex-wrap: wrap;
    }

    .btn {
      padding: var(--space-12) var(--space-24);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      font-family: var(--font-family-base);
      border: none;
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-standard);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-8);
    }

    .btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    .btn-primary {
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--color-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary:active:not(:disabled) {
      background: var(--color-primary-active);
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--color-secondary);
      color: var(--color-text);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--color-secondary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .btn-danger {
      background: var(--color-error);
      color: var(--color-white);
    }

    .btn-danger:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn-info {
      background: var(--color-info);
      color: var(--color-white);
    }

    .btn-info:hover:not(:disabled) {
      opacity: 0.9;
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-full {
      width: 100%;
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .result-card {
      background: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-md);
      padding: var(--space-20);
      margin-top: var(--space-24);
    }

    .result-card h3 {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-16);
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .result-text {
      background: var(--color-bg-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      font-size: var(--font-size-base);
      line-height: 1.8;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
    }

    .json-output {
      background: var(--color-bg-8);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      overflow-x: auto;
      max-height: 500px;
      overflow-y: auto;
    }

    .json-output pre {
      margin: 0;
      font-family: var(--font-family-mono);
      font-size: var(--font-size-sm);
      line-height: 1.6;
      color: var(--color-text);
    }

    .alert {
      padding: var(--space-12) var(--space-16);
      border-radius: var(--radius-base);
      margin-bottom: var(--space-16);
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .alert-success {
      background: rgba(var(--color-success-rgb), 0.1);
      border: 1px solid rgba(var(--color-success-rgb), 0.3);
      color: var(--color-success);
    }

    .alert-error {
      background: rgba(var(--color-error-rgb), 0.1);
      border: 1px solid rgba(var(--color-error-rgb), 0.3);
      color: var(--color-error);
    }

    .alert-info {
      background: rgba(var(--color-info-rgb), 0.1);
      border: 1px solid rgba(var(--color-info-rgb), 0.3);
      color: var(--color-info);
    }

    .hidden {
      display: none;
    }

    .btn-lang-toggle {
      position: absolute;
      top: 0;
      right: 0;
      padding: var(--space-8) var(--space-16);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      background: var(--color-primary);
      color: var(--color-btn-primary-text);
      border: none;
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: all var(--duration-normal) var(--ease-standard);
      z-index: 10;
    }

    .btn-lang-toggle:hover {
      background: var(--color-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .btn-lang-toggle:active {
      background: var(--color-primary-active);
      transform: translateY(0);
    }

    [dir="ltr"] .btn-lang-toggle {
      right: auto;
      left: 0;
    }

    [dir="ltr"] .form-select {
      background-position: right var(--space-12) center;
      padding-left: var(--space-12);
      padding-right: var(--space-32);
    }

    [dir="ltr"] .divider::before {
      margin-left: 0;
      margin-right: var(--space-12);
    }

    [dir="ltr"] .divider::after {
      margin-right: 0;
      margin-left: var(--space-12);
    }

    .icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    @media (max-width: 640px) {
      body {
        padding: var(--space-12);
      }

      .main-card {
        padding: var(--space-20);
      }

      .app-header h1 {
        font-size: var(--font-size-2xl);
      }

      .button-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div style="position: relative;">
        <button id="langToggleBtn" class="btn-lang-toggle" aria-label="Toggle Language">
          <span id="langToggleText">English</span>
        </button>
        <h1 id="headerTitle">استخراج النص وتحويله إلى JSON ديناميكي محسّن</h1>
        <p id="headerSubtitle">قم برفع صورة أو ملف PDF لاستخراج النص وتحويله إلى بيانات منظمة</p>
      </div>
    </header>

    <main class="main-card">
      <div class="form-section">
        <label class="form-label" id="fileUploadLabel">رفع صورة أو ملف PDF</label>
        <div class="file-upload-wrapper">
          <input type="file" id="fileInput" accept=".png,.jpg,.jpeg,.webp,.pdf">
          <div class="file-upload-content">
            <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <div class="upload-text" id="uploadText">اضغط لرفع ملف أو اسحبه هنا</div>
            <div class="upload-hint" id="uploadHint">PNG, JPG, JPEG, WEBP, PDF</div>
          </div>
        </div>
      </div>

      <div class="divider" id="dividerText">أو</div>

      <div class="form-section">
        <label class="form-label" for="urlInput" id="urlInputLabel">أدخل رابط الصورة</label>
        <input type="text" id="urlInput" class="form-input" placeholder="https://example.com/image.jpg">
      </div>

      <div class="form-section">
        <label class="form-label" for="language" id="languageSelectorLabel">اختر اللغة</label>
        <select id="language" class="form-select">
          <option value="auto" id="langOptAuto">كشف تلقائي</option>
          <option value="eng" id="langOptEng">الإنجليزية</option>
          <option value="ara" id="langOptAra">العربية</option>
        </select>
      </div>

      <div class="button-group">
        <button id="startBtn" class="btn btn-primary btn-full">
          <span id="startBtnText">ابدأ التحويل</span>
          <div id="loadingSpinner" class="loading-spinner hidden"></div>
        </button>
      </div>

      <div class="button-group" style="margin-top: var(--space-12);">
        <button id="clearBtn" class="btn btn-danger" style="flex: 1;" data-text-key="button_clear">مسح</button>
        <button id="downloadTxtBtn" class="btn btn-info hidden" style="flex: 1;" data-text-key="button_download_txt">تحميل النص</button>
        <button id="downloadJsonBtn" class="btn btn-secondary hidden" style="flex: 1;" data-text-key="button_download_json">تحميل JSON</button>
      </div>
    </main>

    <div id="alertContainer"></div>

    <div id="resultContainer" class="hidden">
      <div class="result-card">
        <h3>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <span id="extractedTextHeading">النص المستخرج</span>
        </h3>
        <div id="resultText" class="result-text"></div>
      </div>

      <div class="result-card">
        <h3>
          <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
          </svg>
          <span id="dynamicJsonHeading">JSON ديناميكي محسّن</span>
        </h3>
        <div id="jsonOutput" class="json-output"></div>
      </div>
    </div>
  </div>

  <script>
    // Translation system
    const translations = {
      en: {
        header_title: "Extract Text and Convert to Dynamic JSON",
        header_subtitle: "Upload an image or PDF file to extract text and convert it to structured data",
        file_upload_label: "Upload Image or PDF File:",
        upload_text: "Click to upload or drag and drop here",
        upload_hint: "PNG, JPG, JPEG, WEBP, PDF",
        divider: "OR",
        url_input_label: "Or Enter Image URL:",
        url_placeholder: "https://example.com/image.jpg",
        language_selector_label: "Select Language:",
        language_auto: "Auto-Detect",
        language_eng: "English",
        language_ara: "Arabic",
        button_start: "Start Conversion",
        button_start_loading: "Processing...",
        button_clear: "Clear",
        button_download_txt: "Download as TXT",
        button_download_json: "Download as JSON",
        extracted_text_heading: "Extracted Text:",
        dynamic_json_heading: "Dynamic JSON:",
        no_text_found: "No text found.",
        processing: "Processing image...",
        error_message: "An error occurred during processing.",
        error_select_file: "Please upload a file or enter an image URL.",
        alert_file_selected: "File selected: ",
        alert_clear: "All data cleared.",
        alert_download_txt: "Text file downloaded.",
        alert_download_json: "JSON file downloaded.",
        alert_success: "Text extracted successfully!",
        alert_no_text: "No text found in the image.",
        alert_extraction_failed: "Failed to extract text from the image.",
        pdf_converting: "Converting PDF to images...",
        pdf_processing_page: "Processing page",
        pdf_of: "of",
        pdf_success: "PDF processed successfully.",
        pdf_error: "Error processing PDF file."
      },
      ar: {
        header_title: "استخراج النص وتحويله إلى JSON ديناميكي محسّن",
        header_subtitle: "قم برفع صورة أو ملف PDF لاستخراج النص وتحويله إلى بيانات منظمة",
        file_upload_label: "رفع صورة أو ملف PDF:",
        upload_text: "اضغط لرفع ملف أو اسحبه هنا",
        upload_hint: "PNG, JPG, JPEG, WEBP, PDF",
        divider: "أو",
        url_input_label: "أو أدخل رابط الصورة:",
        url_placeholder: "https://example.com/image.jpg",
        language_selector_label: "اختر اللغة:",
        language_auto: "كشف تلقائي",
        language_eng: "الإنجليزية",
        language_ara: "العربية",
        button_start: "ابدأ التحويل",
        button_start_loading: "جاري المعالجة...",
        button_clear: "مسح",
        button_download_txt: "تحميل النص",
        button_download_json: "تحميل JSON",
        extracted_text_heading: "النص المستخرج:",
        dynamic_json_heading: "JSON ديناميكي محسّن:",
        no_text_found: "لم يتم العثور على نص.",
        processing: "جاري معالجة الصورة...",
        error_message: "حدث خطأ أثناء المعالجة.",
        error_select_file: "يرجى رفع ملف أو إدخل رابط الصورة.",
        alert_file_selected: "تم اختيار الملف: ",
        alert_clear: "تم مسح جميع البيانات.",
        alert_download_txt: "تم تحميل ملف النص.",
        alert_download_json: "تم تحميل ملف JSON.",
        alert_success: "تم استخراج النص بنجاح!",
        alert_no_text: "لم يتم العثور على نص في الصورة.",
        alert_extraction_failed: "فشل استخراج النص من الصورة.",
        pdf_converting: "تحويل ملف PDF إلى صور...",
        pdf_processing_page: "معالجة الصفحة",
        pdf_of: "من",
        pdf_success: "تم معالجة ملف PDF بنجاح.",
        pdf_error: "خطأ في معالجة ملف PDF."
      }
    };

    let currentLang = 'ar';
    let extractedText = '';
    let generatedJson = {};

    // Initialize PDF.js
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    function switchLanguage(lang) {
      currentLang = lang;
      const htmlRoot = document.getElementById('htmlRoot');
      const t = translations[lang];
      
      // Update HTML attributes
      htmlRoot.setAttribute('lang', lang);
      htmlRoot.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
      
      // Update all text content
      document.getElementById('headerTitle').textContent = t.header_title;
      document.getElementById('headerSubtitle').textContent = t.header_subtitle;
      document.getElementById('fileUploadLabel').textContent = t.file_upload_label;
      document.getElementById('uploadText').textContent = t.upload_text;
      document.getElementById('uploadHint').textContent = t.upload_hint;
      document.getElementById('dividerText').textContent = t.divider;
      document.getElementById('urlInputLabel').textContent = t.url_input_label;
      document.getElementById('urlInput').placeholder = t.url_placeholder;
      document.getElementById('languageSelectorLabel').textContent = t.language_selector_label;
      document.getElementById('langOptAuto').textContent = t.language_auto;
      document.getElementById('langOptEng').textContent = t.language_eng;
      document.getElementById('langOptAra').textContent = t.language_ara;
      document.getElementById('startBtnText').textContent = t.button_start;
      document.getElementById('clearBtn').textContent = t.button_clear;
      document.getElementById('downloadTxtBtn').textContent = t.button_download_txt;
      document.getElementById('downloadJsonBtn').textContent = t.button_download_json;
      document.getElementById('extractedTextHeading').textContent = t.extracted_text_heading;
      document.getElementById('dynamicJsonHeading').textContent = t.dynamic_json_heading;
      
      // Update toggle button text to show opposite language
      document.getElementById('langToggleText').textContent = lang === 'ar' ? 'English' : 'العربية';
    }

    function showAlert(message, type = 'info') {
      const alertContainer = document.getElementById('alertContainer');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      
      const icon = type === 'error' 
        ? '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        : type === 'success'
        ? '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
        : '<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
      
      alert.innerHTML = icon + '<span>' + message + '</span>';
      alertContainer.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 5000);
    }

    function setLoading(isLoading) {
      const startBtn = document.getElementById('startBtn');
      const startBtnText = document.getElementById('startBtnText');
      const loadingSpinner = document.getElementById('loadingSpinner');
      
      const t = translations[currentLang];
      
      if (isLoading) {
        startBtn.disabled = true;
        startBtnText.textContent = t.button_start_loading;
        loadingSpinner.classList.remove('hidden');
      } else {
        startBtn.disabled = false;
        startBtnText.textContent = t.button_start;
        loadingSpinner.classList.add('hidden');
      }
    }

    async function convertPdfPageToImage(pdf, pageNum) {
      const page = await pdf.getPage(pageNum);
      const scale = 2; // Higher scale for better OCR quality
      const viewport = page.getViewport({ scale });
      
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      canvas.height = viewport.height;
      canvas.width = viewport.width;
      
      await page.render({
        canvasContext: context,
        viewport: viewport
      }).promise;
      
      return new Promise((resolve) => {
        canvas.toBlob((blob) => {
          resolve(blob);
        }, 'image/jpeg', 0.95);
      });
    }

    async function processPdfFile(file, language) {
      const t = translations[currentLang];
      
      try {
        showAlert(t.pdf_converting, 'info');
        
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const totalPages = pdf.numPages;
        
        let allText = '';
        
        for (let pageNum = 1; pageNum <= totalPages; pageNum++) {
          showAlert(`${t.pdf_processing_page} ${pageNum} ${t.pdf_of} ${totalPages}`, 'info');
          
          const imageBlob = await convertPdfPageToImage(pdf, pageNum);
          const ocrResult = await runOCROnImage(imageBlob, language);
          
          if (ocrResult && ocrResult.ParsedResults && ocrResult.ParsedResults[0]) {
            const pageText = ocrResult.ParsedResults[0].ParsedText.trim();
            if (pageText) {
              allText += pageText + '\n\n';
            }
          }
        }
        
        return allText.trim();
      } catch (error) {
        console.error('PDF processing error:', error);
        throw new Error(t.pdf_error);
      }
    }

    async function runOCROnImage(fileOrBlob, language) {
      const formData = new FormData();
      formData.append('apikey', 'K89620932088957');
      formData.append('OCREngine', '2');
      formData.append('language', language);
      formData.append('file', fileOrBlob);

      try {
        const response = await fetch('https://api.ocr.space/parse/image', {
          method: 'POST',
          body: formData,
        });
        return response.json();
      } catch (error) {
        const t = translations[currentLang];
        throw new Error(t.error_message);
      }
    }

    async function runOCR() {
      const file = document.getElementById('fileInput').files[0];
      const url = document.getElementById('urlInput').value.trim();
      const language = document.getElementById('language').value;
      const t = translations[currentLang];

      if (!file && !url) {
        showAlert(t.error_select_file, 'error');
        return null;
      }

      // Check if file is a PDF
      if (file && file.type === 'application/pdf') {
        return await processPdfFile(file, language);
      }

      // Process regular image file or URL
      const formData = new FormData();
      formData.append('apikey', 'K89620932088957');
      formData.append('OCREngine', '2');
      formData.append('language', language);

      if (file) formData.append('file', file);
      else formData.append('url', url);

      try {
        const response = await fetch('https://api.ocr.space/parse/image', {
          method: 'POST',
          body: formData,
        });
        return response.json();
      } catch (error) {
        throw new Error(t.error_message);
      }
    }

    function normalizeArabicNumbers(str) {
      const arabicNums = {
        '٠': '0',
        '١': '1',
        '٢': '2',
        '٣': '3',
        '٤': '4',
        '٥': '5',
        '٦': '6',
        '٧': '7',
        '٨': '8',
        '٩': '9',
      };
      return str.replace(/[٠-٩]/g, (d) => arabicNums[d]);
    }

    function buildDynamicJson(text) {
      text = normalizeArabicNumbers(text);

      const unifiedNumber = text.match(/الرقم الموحد\s*:\s*(\d+)/);
      const establishmentNumber = text.match(/رقم المنشأة\s*:\s*(\d+)/);
      const dates = text.match(/\d{4}\/\d{2}\/\d{2}/g);
      const investedCapital = text.match(/مقدار المال المستثمر\s*:\s*([\d,]+)/);
      const passportNumber = text.match(/رقم الحفيظة أو الجواز\s*:\s*(\d+)/);
      const managerMatch = text.match(/المدير\s*:\s*(.+)/);
      const companyMatch = text.match(/اسم.*الشركة\s*:\s*(.+)/);
      const receiptNumber = text.match(/الإيصال رقم\s*:\s*(\d+)/);

      return {
        certificate: {
          issuing_authority: 'وزارة التجارة',
          certificate_type: 'شهادة تسجيل فرع شركة أجنبية',
          city: text.includes('الرياض') ? 'الرياض' : 'غير محدد',
          issue_date: dates && dates[1] ? dates[1] : 'غير محدد',
          receipt_number: receiptNumber ? receiptNumber[1] : 'غير محدد',
        },
        basic_information: {
          unified_number: unifiedNumber ? unifiedNumber[1] : 'غير محدد',
          establishment_number: establishmentNumber ? establishmentNumber[1] : 'غير محدد',
          company_name: companyMatch ? companyMatch[1].trim() : 'غير محدد',
          company_nationality: text.includes('لبناني') ? 'لبناني' : 'غير محدد',
        },
        validity_period: {
          start_date: dates && dates[0] ? dates[0] : 'غير محدد',
          expiry_date: dates && dates.length > 2 ? dates[2] : 'غير محدد',
        },
        financial_information: {
          invested_capital: investedCapital ? investedCapital[1] : 'غير محدد',
        },
        manager_information: {
          name: managerMatch ? managerMatch[1].trim() : 'غير محدد',
          passport_or_id_number: passportNumber ? passportNumber[1] : 'غير محدد',
        },
      };
    }

    // Language toggle button
    document.getElementById('langToggleBtn').addEventListener('click', function() {
      const newLang = currentLang === 'ar' ? 'en' : 'ar';
      switchLanguage(newLang);
    });

    document.getElementById('startBtn').addEventListener('click', async function() {
      const t = translations[currentLang];
      const file = document.getElementById('fileInput').files[0];
      
      document.getElementById('resultContainer').classList.add('hidden');
      document.getElementById('downloadTxtBtn').classList.add('hidden');
      document.getElementById('downloadJsonBtn').classList.add('hidden');
      
      setLoading(true);
      showAlert(t.processing, 'info');

      try {
        const data = await runOCR();
        if (!data) {
          setLoading(false);
          return;
        }

        // Handle PDF response (returns text directly)
        if (typeof data === 'string') {
          extractedText = data;
          
          if (extractedText) {
            document.getElementById('resultText').textContent = extractedText;
            generatedJson = buildDynamicJson(extractedText);
            document.getElementById('jsonOutput').innerHTML = '<pre>' + JSON.stringify(generatedJson, null, 2) + '</pre>';
            
            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('downloadTxtBtn').classList.remove('hidden');
            document.getElementById('downloadJsonBtn').classList.remove('hidden');
            
            showAlert(t.pdf_success, 'success');
          } else {
            showAlert(t.alert_no_text, 'error');
          }
        }
        // Handle regular image response
        else if (data.ParsedResults && data.ParsedResults[0]) {
          extractedText = data.ParsedResults[0].ParsedText.trim();
          
          if (extractedText) {
            document.getElementById('resultText').textContent = extractedText;
            generatedJson = buildDynamicJson(extractedText);
            document.getElementById('jsonOutput').innerHTML = '<pre>' + JSON.stringify(generatedJson, null, 2) + '</pre>';
            
            document.getElementById('resultContainer').classList.remove('hidden');
            document.getElementById('downloadTxtBtn').classList.remove('hidden');
            document.getElementById('downloadJsonBtn').classList.remove('hidden');
            
            showAlert(t.alert_success, 'success');
          } else {
            showAlert(t.alert_no_text, 'error');
          }
        } else {
          showAlert(t.alert_extraction_failed, 'error');
        }
      } catch (error) {
        showAlert(t.error_message + ': ' + error.message, 'error');
        console.error(error);
      } finally {
        setLoading(false);
      }
    });

    document.getElementById('clearBtn').addEventListener('click', function() {
      const t = translations[currentLang];
      document.getElementById('fileInput').value = '';
      document.getElementById('urlInput').value = '';
      document.getElementById('resultContainer').classList.add('hidden');
      document.getElementById('downloadTxtBtn').classList.add('hidden');
      document.getElementById('downloadJsonBtn').classList.add('hidden');
      extractedText = '';
      generatedJson = {};
      showAlert(t.alert_clear, 'info');
    });

    document.getElementById('downloadTxtBtn').addEventListener('click', function() {
      const t = translations[currentLang];
      const blob = new Blob([extractedText], { type: 'text/plain' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'OCR_Result.txt';
      link.click();
      showAlert(t.alert_download_txt, 'success');
    });

    document.getElementById('downloadJsonBtn').addEventListener('click', function() {
      const t = translations[currentLang];
      const blob = new Blob([JSON.stringify(generatedJson, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'OCR_Result.json';
      link.click();
      showAlert(t.alert_download_json, 'success');
    });

    // File name display
    document.getElementById('fileInput').addEventListener('change', function(e) {
      if (e.target.files.length > 0) {
        const t = translations[currentLang];
        const fileName = e.target.files[0].name;
        showAlert(t.alert_file_selected + fileName, 'success');
      }
    });

    // Initialize with default language (Arabic)
    switchLanguage('ar');
  </script>
</body>
</html>